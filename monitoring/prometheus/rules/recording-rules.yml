# GXVIS Recording Rules
# Pre-aggregated metrics for dashboard performance

groups:
#═════════════════════════════════════════════════════════════════
# HTTP Metrics (RED Method)
#═════════════════════════════════════════════════════════════════
- name: gxvis_http_recording_rules
  interval: 30s
  rules:
  # Request rate per route (5min window)
  - record: gxvis:http_requests:rate5m
    expr: sum(rate(gxvis_http_requests_total[5m])) by (route, method, status)

  # Error rate (5xx) per route
  - record: gxvis:http_errors:rate5m
    expr: sum(rate(gxvis_http_requests_total{status=~"5.."}[5m])) by (route)

  # Success rate per route
  - record: gxvis:http_success_rate:rate5m
    expr: |
      sum(rate(gxvis_http_requests_total{status!~"5.."}[5m])) by (route)
      /
      sum(rate(gxvis_http_requests_total[5m])) by (route)

  # Latency quantiles (P50, P95, P99) per route
  - record: gxvis:http_request_duration:p50
    expr: histogram_quantile(0.50, sum(rate(gxvis_http_request_duration_seconds_bucket[5m])) by (route, le))

  - record: gxvis:http_request_duration:p95
    expr: histogram_quantile(0.95, sum(rate(gxvis_http_request_duration_seconds_bucket[5m])) by (route, le))

  - record: gxvis:http_request_duration:p99
    expr: histogram_quantile(0.99, sum(rate(gxvis_http_request_duration_seconds_bucket[5m])) by (route, le))

#═════════════════════════════════════════════════════════════════
# RSS Fetching Metrics
#═════════════════════════════════════════════════════════════════
- name: gxvis_rss_recording_rules
  interval: 1m
  rules:
  # RSS fetch success rate per feed
  - record: gxvis:rss_fetch:success_rate1h
    expr: |
      sum(rate(gxvis_rss_fetch_total{status="success"}[1h])) by (feed_name)
      /
      sum(rate(gxvis_rss_fetch_total[1h])) by (feed_name)

  # New items per hour per feed
  - record: gxvis:rss_items_new:rate1h
    expr: sum(rate(gxvis_rss_items_fetched_total{is_new="true"}[1h])) by (feed_name)

  # Average fetch duration per feed
  - record: gxvis:rss_fetch_duration:avg
    expr: |
      sum(rate(gxvis_rss_fetch_duration_seconds_sum[10m])) by (feed_name)
      /
      sum(rate(gxvis_rss_fetch_duration_seconds_count[10m])) by (feed_name)

#═════════════════════════════════════════════════════════════════
# Draft Generation Metrics
#═════════════════════════════════════════════════════════════════
- name: gxvis_draft_recording_rules
  interval: 1m
  rules:
  # Draft generation success rate
  - record: gxvis:draft_generation:success_rate30m
    expr: |
      sum(rate(gxvis_draft_generation_total{status="success"}[30m]))
      /
      sum(rate(gxvis_draft_generation_total[30m]))

  # Drafts generated per hour
  - record: gxvis:drafts_generated:rate1h
    expr: sum(rate(gxvis_draft_generation_total{status="success"}[1h]))

  # Drafts generated by template (1h rate)
  - record: gxvis:drafts_by_template:rate1h
    expr: sum(rate(gxvis_drafts_generated_by_template_total[1h])) by (template_code)

  # Average generation duration
  - record: gxvis:draft_generation_duration:avg
    expr: |
      sum(rate(gxvis_draft_generation_duration_seconds_sum[10m]))
      /
      sum(rate(gxvis_draft_generation_duration_seconds_count[10m]))

#═════════════════════════════════════════════════════════════════
# Database Metrics
#═════════════════════════════════════════════════════════════════
- name: gxvis_db_recording_rules
  interval: 30s
  rules:
  # Database query rate per model
  - record: gxvis:db_queries:rate5m
    expr: sum(rate(gxvis_db_queries_total[5m])) by (model, operation)

  # Database error rate per model
  - record: gxvis:db_errors:rate5m
    expr: sum(rate(gxvis_db_queries_total{status="error"}[5m])) by (model)

  # Average query duration per model
  - record: gxvis:db_query_duration:avg
    expr: |
      sum(rate(gxvis_db_query_duration_seconds_sum[5m])) by (model, operation)
      /
      sum(rate(gxvis_db_query_duration_seconds_count[5m])) by (model, operation)

  # P95 query duration per model
  - record: gxvis:db_query_duration:p95
    expr: histogram_quantile(0.95, sum(rate(gxvis_db_query_duration_seconds_bucket[5m])) by (model, operation, le))

#═════════════════════════════════════════════════════════════════
# Business Metrics
#═════════════════════════════════════════════════════════════════
- name: gxvis_business_recording_rules
  interval: 5m
  rules:
  # Review decisions per hour
  - record: gxvis:review_decisions:rate1h
    expr: sum(rate(gxvis_review_decisions_total[1h])) by (action)

  # Draft approval rate (24h window)
  - record: gxvis:draft_approval_rate:24h
    expr: |
      sum(rate(gxvis_review_decisions_total{action="approve"}[24h]))
      /
      sum(rate(gxvis_review_decisions_total[24h]))

  # Draft rejection rate (24h window)
  - record: gxvis:draft_rejection_rate:24h
    expr: |
      sum(rate(gxvis_review_decisions_total{action="reject"}[24h]))
      /
      sum(rate(gxvis_review_decisions_total[24h]))

  # Average time to review (from creation to decision)
  - record: gxvis:draft_review_duration:avg
    expr: |
      sum(rate(gxvis_draft_review_duration_seconds_sum[1h]))
      /
      sum(rate(gxvis_draft_review_duration_seconds_count[1h]))

  # Draft edit rate (% of decisions with edits)
  - record: gxvis:draft_edit_rate:24h
    expr: |
      sum(rate(gxvis_draft_edits_total[24h]))
      /
      sum(rate(gxvis_review_decisions_total[24h]))

#═════════════════════════════════════════════════════════════════
# Job Execution Metrics
#═════════════════════════════════════════════════════════════════
- name: gxvis_job_recording_rules
  interval: 2m
  rules:
  # Job success rate per job type
  - record: gxvis:job_success_rate:1h
    expr: |
      sum(rate(gxvis_job_executions_total{status="success"}[1h])) by (job_type)
      /
      sum(rate(gxvis_job_executions_total[1h])) by (job_type)

  # Average job duration
  - record: gxvis:job_duration:avg
    expr: |
      sum(rate(gxvis_job_execution_duration_seconds_sum[1h])) by (job_type)
      /
      sum(rate(gxvis_job_execution_duration_seconds_count[1h])) by (job_type)

#═════════════════════════════════════════════════════════════════
# SLO Metrics (Error Budget Tracking)
#═════════════════════════════════════════════════════════════════
- name: gxvis_slo_recording_rules
  interval: 1m
  rules:
  # Availability SLI (uptime)
  - record: gxvis:sli:availability
    expr: avg(up{job="gxvis-app"})

  # Error rate SLI (requests without 5xx errors)
  - record: gxvis:sli:error_rate
    expr: |
      sum(rate(gxvis_http_requests_total{status!~"5.."}[5m]))
      /
      sum(rate(gxvis_http_requests_total[5m]))

  # Latency SLI (P95 < 2s)
  - record: gxvis:sli:latency_p95
    expr: |
      histogram_quantile(0.95,
        sum(rate(gxvis_http_request_duration_seconds_bucket{route=~"/api/.*"}[5m])) by (le)
      ) < 2

  # Draft generation SLI (success rate > 95%)
  - record: gxvis:sli:draft_generation
    expr: |
      sum(rate(gxvis_draft_generation_total{status="success"}[30m]))
      /
      sum(rate(gxvis_draft_generation_total[30m]))

  # RSS fetch SLI (success rate > 90%)
  - record: gxvis:sli:rss_fetch
    expr: |
      sum(rate(gxvis_rss_fetch_total{status="success"}[1h]))
      /
      sum(rate(gxvis_rss_fetch_total[1h]))
