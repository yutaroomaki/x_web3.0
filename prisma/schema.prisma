generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum SourceType {
  X_SEARCH
  RSS
  YOUTUBE_SEARCH
  YOUTUBE_CHANNEL
  MANUAL
}

enum DraftStatus {
  pending
  approved
  rejected
  posted
}

enum DecisionAction {
  approve
  reject
  posted
}

enum JobStatus {
  running
  success
  failed
}

model Source {
  id          String       @id @default(cuid())
  type        SourceType
  name        String
  config      Json
  enabled     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  ingestItems IngestItem[]

  @@index([type])
  @@index([enabled])
}

model IngestItem {
  id           String          @id @default(cuid())
  sourceId     String
  source       Source          @relation(fields: [sourceId], references: [id], onDelete: Restrict)
  externalId   String          @unique
  url          String
  publishedAt  DateTime
  ingestedAt   DateTime        @default(now())
  language     String?
  text         String?
  metrics      Json
  raw          Json
  createdAt    DateTime        @default(now())

  buzzCandidate BuzzCandidate?
  viralAnalysis ViralAnalysis?
  outline       Outline?
  draftPosts    DraftPost[]

  @@index([publishedAt])
  @@index([ingestedAt])
  @@index([sourceId])
}

model BuzzCandidate {
  id           String     @id @default(cuid())
  ingestItemId String     @unique
  ingestItem   IngestItem @relation(fields: [ingestItemId], references: [id], onDelete: Cascade)
  score        Int
  reasons      Json
  createdAt    DateTime   @default(now())

  @@index([score])
  @@index([createdAt])
}

model ViralAnalysis {
  id             String     @id @default(cuid())
  ingestItemId   String     @unique
  ingestItem     IngestItem @relation(fields: [ingestItemId], references: [id], onDelete: Cascade)
  hookType       String
  ctaType        String
  emotionProfile Json
  templateGuess  String
  summary        String
  risks          Json
  createdAt      DateTime   @default(now())
}

model Outline {
  id           String     @id @default(cuid())
  ingestItemId String     @unique
  ingestItem   IngestItem @relation(fields: [ingestItemId], references: [id], onDelete: Cascade)
  templateType String
  hookDraft    String
  keyPoints    Json
  ctaDraft     String
  emotionPlan  Json
  createdAt    DateTime   @default(now())
}

model Template {
  id         String      @id @default(cuid())
  code       String      @unique
  name       String
  body       Json
  createdAt  DateTime    @default(now())
  draftPosts DraftPost[]
}

model DraftPost {
  id              String           @id @default(cuid())
  ingestItemId    String
  ingestItem      IngestItem       @relation(fields: [ingestItemId], references: [id], onDelete: Restrict)
  templateId      String
  template        Template         @relation(fields: [templateId], references: [id], onDelete: Restrict)
  postText        String
  emotionTriggers Json
  trendScore      Int
  riskFlags       Json
  status          DraftStatus      @default(pending)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  reviewDecisions ReviewDecision[]

  @@index([status])
  @@index([trendScore])
  @@index([createdAt])
}

model ReviewDecision {
  id          String         @id @default(cuid())
  draftPostId String
  draftPost   DraftPost      @relation(fields: [draftPostId], references: [id], onDelete: Cascade)
  action      DecisionAction
  editedText  String?
  note        String?
  createdAt   DateTime       @default(now())

  @@index([action])
  @@index([createdAt])
}

model JobRun {
  id         String    @id @default(cuid())
  jobType    String
  status     JobStatus
  stats      Json
  error      Json?
  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  @@index([status])
  @@index([startedAt])
}
